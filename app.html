<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holostats Spielerstatistik-Suche</title>
    <style>
        /* === Allgemeiner Stil und Dunkles Thema === */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1e1e1e;
            color: #f0f0f0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 50px;
        }
        .container {
            display: none;
            width: 90%;
            max-width: 700px;
            background: #2d2d30;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h1 {
            color: #4CAF50;
            text-align: center;
        }
        /* ... weitere Stile ... */
        
        /* NEUE STILE FÜR ADMIN-MENÜ UND ANFRAGE */
        #admin-menu {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            background-color: #3a3a3d;
            display: none; /* Standardmäßig versteckt */
        }
        .request-item {
            border-bottom: 1px solid #555;
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .request-item:last-child {
            border-bottom: none;
        }
        .request-details {
            flex-basis: 60%;
        }
        .request-actions {
            flex-basis: 35%;
            text-align: right;
        }
        .request-actions textarea {
            width: 90%;
            margin-top: 5px;
            background-color: #1e1e1e;
            color: #f0f0f0;
            border: 1px solid #555;
            padding: 5px;
            border-radius: 4px;
        }
        .btn-approve, .btn-reject {
            padding: 8px 15px;
            margin-left: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-approve {
            background-color: #4CAF50;
            color: white;
        }
        .btn-reject {
            background-color: #f44336;
            color: white;
        }

        /* Stil für die Anfrage-Sektion (für Rolle 'self') */
        #request-access-section {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #555;
            border-radius: 8px;
            background-color: #3a3a3d;
            display: none; /* Standardmäßig versteckt */
        }

        /* Stil für Lade-Icon */
        .loading-icon {
            width: 30px;
            height: 30px;
            vertical-align: middle;
            margin-right: 10px;
        }
    </style>
    </head>
<body>

<div id="login-modal-overlay" style="display: none; /* initial hidden */">
    </div>

<div class="container">
    <h1>Holostats Spielerstatistik-Suche</h1>

    <div id="admin-menu">
        <h2>Zugriffsanfragen</h2>
        <div id="request-list">
            </div>
    </div>
    
    <div id="player-data-display">
        <p>Geben Sie einen Spielernamen ein, um dessen Statistik zu sehen.</p>
        <input type="text" id="player-search" placeholder="Spielername">
        <button onclick="searchPlayer()">Suchen</button>
        <div id="search-results"></div>
    </div>
    
    <div id="request-access-section">
        <h3>Zugriff auf andere Spielerdaten anfordern</h3>
        <input type="text" id="request-target-player" placeholder="Spielername für den Zugriff">
        <textarea id="request-reason" placeholder="Grund für die Anfrage (erforderlich)" rows="3"></textarea>
        <button onclick="submitAccessRequest()">Anfrage senden</button>
        <p id="request-message" style="color: yellow; margin-top: 10px;"></p>
    </div>
    
    </div>

<script>
    // Konstanten beibehalten
    const LOGIN_KEY = 'isLoggedIn';
    const CURRENT_USER_KEY = 'currentUser';
    const TARGET_PAGE = 'app (2).html'; 

    // MOCK-ACCOUNTS (Ihre neue Struktur)
    const MOCK_ACCOUNTS = [
        { "username": "JasonNewAcc", "password": "1234", "role": "admin" },
        { "username": "Lattenrost1234", "password": "1234", "role": "moderator" },
        { "username": "Admin", "password": "passwort_sicher", "role": "admin" },
        { "username": "TestUser", "password": "test", "role": "self" }
    ];
    
    // MOCK-Daten für Anfragen (im sessionStorage gespeichert)
    const REQUESTS_KEY = 'pendingRequests';
    
    function loadAccounts() {
        // Simuliert das Laden der Konten, wie in Ihrer Originaldatei
        window.validAccounts = MOCK_ACCOUNTS;
        return true; 
    }
    
    // --- NEUE FUNKTIONEN ---

    // 1. Rollen- und Datenanzeige-Logik
    function initializeApp() {
        const currentUser = JSON.parse(sessionStorage.getItem(CURRENT_USER_KEY));
        
        // Admin- oder Moderator-spezifische UI
        if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'moderator')) {
            document.getElementById('admin-menu').style.display = 'block';
            loadPendingRequests();
        } else if (currentUser && currentUser.role === 'self') {
            // Logik für Rolle 'self'
            // Standardmäßig nur Suche nach sich selbst erlauben
            document.getElementById('request-access-section').style.display = 'block';
            
            // In der echten Anwendung würden Sie hier prüfen, ob der 'self'-User bereits 
            // Zugriff auf andere Spieler hat (z.B. über ein weiteres 'sessionStorage'-Feld)
            // oder das Suchfeld einschränken.
            document.getElementById('player-search').value = currentUser.username;
            document.getElementById('player-search').disabled = true; // Suchfeld auf eigenen Namen fixieren
            document.getElementById('player-data-display').querySelector('p').textContent = `Willkommen, ${currentUser.username}. Sie sehen nur Ihre eigenen Umsätze.`;
        }

        // ... Rest Ihrer initializeApp Logik ...
    }
    
    // 2. Anfragen-Logik (für Rolle 'self')
    function submitAccessRequest() {
        const currentUser = JSON.parse(sessionStorage.getItem(CURRENT_USER_KEY));
        const targetPlayer = document.getElementById('request-target-player').value.trim();
        const reason = document.getElementById('request-reason').value.trim();
        const messageElement = document.getElementById('request-message');

        if (currentUser.role !== 'self') {
             messageElement.textContent = 'Fehler: Nur die Rolle "self" kann Anfragen senden.';
             messageElement.style.color = 'red';
             return;
        }

        if (!targetPlayer || !reason) {
            messageElement.textContent = 'Bitte geben Sie sowohl einen Zielspieler als auch einen Grund an.';
            messageElement.style.color = 'red';
            return;
        }

        // Mock-Speicherung der Anfrage
        const pendingRequests = JSON.parse(sessionStorage.getItem(REQUESTS_KEY) || '[]');
        
        const newRequest = {
            id: Date.now(),
            requester: currentUser.username,
            targetPlayer: targetPlayer,
            reason: reason,
            date: new Date().toLocaleDateString('de-DE')
        };
        
        pendingRequests.push(newRequest);
        sessionStorage.setItem(REQUESTS_KEY, JSON.stringify(pendingRequests));
        
        messageElement.textContent = `Anfrage für Spieler ${targetPlayer} wurde gesendet. Ein Administrator wird sie prüfen.`;
        messageElement.style.color = '#4CAF50';
        
        // Eingabefelder leeren
        document.getElementById('request-target-player').value = '';
        document.getElementById('request-reason').value = '';
    }

    // 3. Admin-Menü Logik (für Rolle 'admin'/'moderator')
    function loadPendingRequests() {
        const requestListElement = document.getElementById('request-list');
        const pendingRequests = JSON.parse(sessionStorage.getItem(REQUESTS_KEY) || '[]');
        requestListElement.innerHTML = ''; 

        if (pendingRequests.length === 0) {
            requestListElement.innerHTML = '<p>Keine offenen Zugriffsanfragen.</p>';
            return;
        }

        // Fügen Sie das von Ihnen angehängte Bild als Lade-Icon hinzu
        requestListElement.innerHTML = `<p><img src="waiting-icon-gif-5.jpg-f27abb9b-f032-43c9-974a-10897721deb0" alt="Lädt..." class="loading-icon">Neue Anfragen (${pendingRequests.length}) warten auf Genehmigung:</p>`;

        pendingRequests.forEach(request => {
            const requestItem = document.createElement('div');
            requestItem.className = 'request-item';
            requestItem.dataset.id = request.id;
            
            requestItem.innerHTML = `
                <div class="request-details">
                    <strong>Von:</strong> ${request.requester}<br>
                    <strong>Zugriff auf:</strong> ${request.targetPlayer}<br>
                    <strong>Grund:</strong> ${request.reason} 
                </div>
                <div class="request-actions">
                    <textarea id="reason-${request.id}" placeholder="Grund für Genehmigung/Ablehnung (Pflichtfeld)" required></textarea>
                    <button class="btn-approve" onclick="handleAccessRequest(${request.id}, 'approve')">Genehmigen</button>
                    <button class="btn-reject" onclick="handleAccessRequest(${request.id}, 'reject')">Ablehnen</button>
                </div>
            `;
            requestListElement.appendChild(requestItem);
        });
    }

    // 4. Verarbeitung von Genehmigungen/Ablehnungen
    function handleAccessRequest(requestId, action) {
        const reasonInput = document.getElementById(`reason-${requestId}`);
        const adminReason = reasonInput.value.trim();

        if (!adminReason) {
            alert('Bitte geben Sie einen Grund für die ' + (action === 'approve' ? 'Genehmigung' : 'Ablehnung') + ' an.');
            return;
        }

        let pendingRequests = JSON.parse(sessionStorage.getItem(REQUESTS_KEY) || '[]');
        const requestIndex = pendingRequests.findIndex(r => r.id === requestId);
        
        if (requestIndex !== -1) {
            const [request] = pendingRequests.splice(requestIndex, 1);
            
            // Protokollierung/Verarbeitung der Entscheidung (Mock)
            console.log(`Anfrage von ${request.requester} für ${request.targetPlayer} wurde ${action === 'approve' ? 'GENEHMIGT' : 'ABGELEHNT'}. Admin-Grund: ${adminReason}`);
            
            // In einer echten App:
            // Wenn 'approve', würden Sie die Rechte des 'requester' in der Datenbank/auf dem Server aktualisieren.
            
            sessionStorage.setItem(REQUESTS_KEY, JSON.stringify(pendingRequests));
            loadPendingRequests(); // Liste aktualisieren
            
            alert(`Anfrage ${requestId} wurde erfolgreich ${action === 'approve' ? 'genehmigt' : 'abgelehnt'}.`);
        }
    }
    
    // --- Bestehende Logik angepasst ---
    
    // Schließen des Modals durch Klicken außerhalb des Inhalts
    window.onclick = function(event) {
        // ... (unverändert) ...
    }
    
    // Haupt-DOMContentLoaded-Handler zur Authentifizierung
    document.addEventListener('DOMContentLoaded', async () => { 
        
        // NEU: 1. Zuerst Accounts laden
        const accountsLoaded = await loadAccounts();
        if (!accountsLoaded) {
            // Wenn Accounts nicht geladen werden konnten, das Login-Overlay anzeigen und warten
            document.getElementById('login-modal-overlay').style.display = 'flex';
            return;
        }
        
        // 2. Prüfen, ob bereits eingeloggt
        const isLoggedIn = sessionStorage.getItem(LOGIN_KEY) === 'true';
        const container = document.querySelector('.container');
        const loginOverlay = document.getElementById('login-modal-overlay');

        if (isLoggedIn) {
            // Bereits eingeloggt
            loginOverlay.style.display = 'none';
            container.style.display = 'block'; // Zeige Hauptinhalt
            initializeApp(); // Ruft die neue Logik auf
        } else {
            // Zeige Login-Overlay
            loginOverlay.style.display = 'flex';
            // Setze den Fokus auf das Eingabefeld
            // document.getElementById('login-username').focus(); // Wird in index.html gemacht
        }
    });

    // Platzhalter für die Suchfunktion, um Fehler zu vermeiden
    function searchPlayer() {
        const playerName = document.getElementById('player-search').value;
        document.getElementById('search-results').innerHTML = `<p>Simulierte Daten für: <strong>${playerName}</strong>. (Implementierung der echten Daten fehlt)</p>`;
    }

</script>
</body>
</html>
